// ==UserScript==
// @name         Nova Tela ISP - Agendamentos
// @namespace    http://tampermonkey.net/
// @version      1.0
// @description  Nova Tela de agendados para o ISP.
// @author       Wesley GG
// @match        https://integrator6.gegnet.com.br/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=gegnet.com.br
// @grant        GM_xmlhttpRequest
// @grant        GM_addStyle
// @grant        GM_getResourceText
// @resource bootstrap https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css#sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC
// ==/UserScript==

(function () {
    'use strict';

    const URL_AGENDADOS_SZ = 'https://noc-ferramentas.gegnet.com.br/json.php';
    const URL_AGENDADOS_NOC = 'https://noc-ferramentas.gegnet.com.br/json_noc.php';

    let CONTEUDO_DIV;
    let div_principal;
    let agendados_sz = null;
    let agendados_noc = null;

    function retornarAgendados(url, callback) {
        GM_xmlhttpRequest({
            method: "GET",
            url: url,
            headers: {
                "Content-Type": "application/json"
            },
            onload: function (response) {
                const agendados = JSON.parse(response.responseText);

                if (agendados.erro || agendados.length === 0) {
                    console.log("Não tem nenhum agendamento marcado.");
                    callback(null);
                } else {
                    callback(agendados);
                }
            }
        });
    }

    function clearElements() {
        if (CONTEUDO_DIV) {
            const filhos = CONTEUDO_DIV.children;

            if (filhos.length > 1) {
                filhos[1].innerHTML = '';
                div_principal = filhos[1];

                loadTable();
            }
        }
    }

    function addValuesInTable(agendados, isNoc) {
        let tbody = document.getElementById('tbody');
        tbody.innerHTML = '';

        for (const agendado of agendados) {
            let data;
            if (isNoc) {
                data = [
                    agendado.id,
                    agendado.protocolo_noc,
                    agendado.nome_usuario,
                    agendado.dataHora_noc,
                    agendado.Observacao
                ];
            } else {
                data = [
                    agendado.id,
                    agendado.protocolo,
                    agendado.usuario,
                    agendado.dataHora,
                    agendado.observacao
                ];
            }

            let line = document.createElement('tr');
            for (const element of data) {
                let column = document.createElement('td');
                column.textContent = element || '';
                line.appendChild(column);
            }
            tbody.appendChild(line);
        }
    }

    function estilos() {
        GM_addStyle(`
        #send-schudle {
            background-color: #286090;
            color: white;
            margin-bottom: 5px;
        }

        .group-form {
            display: flex;
            flex-wrap: wrap;
        }

        .group-form > div {
            flex: 1 1 auto;
            padding: 5px;
        }

        .group-form label {
            flex-basis: 100px;
            flex-shrink: 0;
            text-align: right;
            padding-right: 10px;
        }

        .group-form input,
        .group-form textarea,
        .group-form button {
            flex: 1 1 auto;
        }

        .mb-3 {
            margin-bottom: 3px;
        }

        .btn-toggle-json {
            margin-right: 5px;
            width: 300px;
            background-color: #286090;
            color: white;
        }

        .btn-group {
            margin-bottom: 15px;
        }

        .table-container {
            max-height: 50%; /* Altura máxima da tabela */
            overflow-y: auto; /* Adiciona scroll vertical se necessário */
        }
        `);
    }

    function loadTable() {
        estilos();
        const divCriarAgendamento = div_principal;
        divCriarAgendamento.innerHTML = `
        <div _ngcontent-c15="" class="panel-heading"><div _ngcontent-c15="" class="panel-title"> Agendados SZ </div></div>
        <div class="add-schudle" id="add-schudle">
            <div class="group-form mb-3">
                <div>
                    <label for="protocol" class="form-label">Protocolo</label>
                    <input type="number" id="protocol" class="form-control" placeholder="xxxxx">
                </div>
                <div>
                    <label for="date-schudle" class="form-label">Data & Horário Marcado</label>
                    <input type="datetime-local" class="form-control" id="date-schudle">
                </div>
            </div>
            <div class="mb-3">
                <label for="obs-schudle" class="form-label">Observação</label>
                <textarea class="form-control" id="obs-schudle"></textarea>
            </div>
            <button id="send-schudle" class="btn btn-primary">Enviar</button>
        </div>
        `;

        const tableContainer = document.createElement('div');
        tableContainer.classList.add('table-container');
        divCriarAgendamento.appendChild(tableContainer);

        const viewSchudlesDiv = document.createElement('div');
        viewSchudlesDiv.classList.add('view-schudles');
        tableContainer.appendChild(viewSchudlesDiv);

        const labelDiv = document.createElement('div');
        labelDiv.classList.add('form-label');
        labelDiv.textContent = 'Selecione o Tipo de Agendados:';
        viewSchudlesDiv.appendChild(labelDiv);

        const btnGroupDiv = document.createElement('div');
        btnGroupDiv.classList.add('btn-group');
        btnGroupDiv.setAttribute('role', 'group');
        viewSchudlesDiv.appendChild(btnGroupDiv);

        const btnSZ = document.createElement('button');
        btnSZ.setAttribute('type', 'button');
        btnSZ.setAttribute('id', 'btn-sz');
        btnSZ.classList.add('btn', 'btn-toggle-json');
        btnSZ.textContent = 'Agendados SZ';
        btnGroupDiv.appendChild(btnSZ);

        const btnNOC = document.createElement('button');
        btnNOC.setAttribute('type', 'button');
        btnNOC.setAttribute('id', 'btn-noc');
        btnNOC.classList.add('btn', 'btn-toggle-json');
        btnNOC.textContent = 'Agendados NOC';
        btnGroupDiv.appendChild(btnNOC);

        const table = document.createElement('table');
        table.classList.add('table', 'table-striped', 'table-bordered', 'mt-3');
        viewSchudlesDiv.appendChild(table);

        const thead = document.createElement('thead');
        table.appendChild(thead);

        const tr = document.createElement('tr');
        thead.appendChild(tr);

        const th1 = document.createElement('th');
        th1.setAttribute('scope', 'col');
        th1.textContent = 'ID';
        tr.appendChild(th1);

        const th2 = document.createElement('th');
        th2.setAttribute('scope', 'col');
        th2.textContent = 'Protocolo';
        tr.appendChild(th2);

        const th3 = document.createElement('th');
        th3.setAttribute('scope', 'col');
        th3.textContent = 'Nome de Usuário';
        tr.appendChild(th3);

        const th4 = document.createElement('th');
        th4.setAttribute('scope', 'col');
        th4.textContent = 'Horário';
        tr.appendChild(th4);

        const th5 = document.createElement('th');
        th5.setAttribute('scope', 'col');
        th5.textContent = 'Observação';
        tr.appendChild(th5);

        const tbody = document.createElement('tbody');
        tbody.setAttribute('id', 'tbody');
        table.appendChild(tbody);

        document.getElementById('btn-sz').addEventListener('click', function () {
            document.querySelector('.panel-title').textContent = 'Agendados SZ'
            addValuesInTable(agendados_sz, false);
        });

        document.getElementById('btn-noc').addEventListener('click', function () {
            document.querySelector('.panel-title').textContent = 'Agendados Suporte'
            addValuesInTable(agendados_noc, true);
        });

        addValuesInTable(agendados_sz, false); // Carrega os agendados_sz por padrão
    }

    function adicionarIconeAgendamento() {
        const intervalId = setInterval(() => {
            try {
                const fontAwesomeLink = document.createElement('link');
                fontAwesomeLink.rel = 'stylesheet';
                fontAwesomeLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css';
                document.head.appendChild(fontAwesomeLink);

                let titleBar = document.createElement('div');
                titleBar.style.backgroundColor = '#1a428a';
                titleBar.style.color = '#fff';
                titleBar.style.padding = '5px 10px';
                titleBar.style.fontWeight = 'bold';
                titleBar.style.width = '100%';
                titleBar.style.cursor = 'pointer';
                titleBar.style.transition = 'background-color 0.3s ease';

                const icon = document.createElement('i');
                icon.className = 'fas fa-calendar-alt';
                icon.style.fontSize = '24px';

                titleBar.appendChild(icon);

                const bar = document.querySelector("#bar1");
                const dropdownDiv = document.createElement('div');
                dropdownDiv.setAttribute('_ngcontent-c4', '');
                dropdownDiv.classList.add('dropdown', 'ng-star-inserted');
                dropdownDiv.setAttribute('role', 'presentation');
                dropdownDiv.addEventListener('click', clearElements);

                const innerDiv = document.createElement('div');
                innerDiv.setAttribute('_ngcontent-c4', '');
                innerDiv.setAttribute('aria-expanded', 'true');
                innerDiv.setAttribute('aria-haspopup', 'true');
                innerDiv.classList.add('item', 'dropdown-toggle');
                innerDiv.setAttribute('data-toggle', 'dropdown');
                innerDiv.setAttribute('type', 'button');

                const bodyDiv = document.createElement('div');
                bodyDiv.setAttribute('_ngcontent-c4', '');
                bodyDiv.setAttribute('data-placement', 'right');
                bodyDiv.setAttribute('title', 'Agendados');

                const titleIcon = document.createElement('strong');
                titleIcon.setAttribute('_ngcontent-c4', '');
                titleIcon.setAttribute('class', 'titulo');
                titleIcon.textContent = "Agendados";

                const spanicon = document.createElement('span');
                spanicon.style.fontSize = '24px';
                spanicon.setAttribute('_ngcontent-c4', '');
                spanicon.classList.add('fas', 'fa-calendar-alt');

                bodyDiv.appendChild(spanicon);
                bodyDiv.appendChild(titleIcon);

                innerDiv.appendChild(bodyDiv);
                dropdownDiv.appendChild(innerDiv);

                bar.appendChild(dropdownDiv);

                clearInterval(intervalId);
            } catch {}

        }, 1000);
    }

    console.log('Esperando');
    const first_interval = setInterval(() => {
        CONTEUDO_DIV = document.querySelector(".conteudo");
        if (CONTEUDO_DIV) {
            clearInterval(first_interval);
            adicionarIconeAgendamento();
            console.log("PASSOU");

            retornarAgendados(URL_AGENDADOS_SZ, function (result) {
                agendados_sz = result;
                console.log(agendados_sz);
                addValuesInTable(agendados_sz, false); // Atualiza a tabela com dados SZ ao carregar
            });

            retornarAgendados(URL_AGENDADOS_NOC, function (result) {
                agendados_noc = result;
                console.log(agendados_noc);
            });
        }
    }, 1000);

})();
